<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Symbiotic Meme Gallery</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    margin:0; 
    padding:0; 
    background:#f0f0f0; 
    color:#333; 
  }

  header { 
    background:#4CAF50; 
    color:white; 
    padding:1rem; 
    text-align:center; 
  }

  main { 
    max-width: 1000px; 
    margin: auto; 
    padding: 1rem; 
    background: rgba(57, 255, 20, 0.05); /* faded neon green */
    border-radius: 10px;
  }

  form { 
    display:flex; 
    flex-direction:column; 
    gap:0.5rem; 
    margin-bottom:1rem; 
  }

  input[type="text"], input[type="url"], input[type="file"] { 
    padding:0.5rem; 
    font-size:1rem; 
    width:100%; 
  }

  button { 
    padding:0.6rem; 
    font-size:1rem; 
    background:#4CAF50; 
    color:white; 
    border:none; 
    cursor:pointer; 
    transition:0.2s; 
  }

  button:disabled { 
    background:#999; 
    cursor:not-allowed; 
  }

  button:hover:not(:disabled) { 
    background:#45a049; 
  }

  progress { 
    width:100%; 
    display:none; 
    margin-bottom:0.5rem; 
  }

  /* Gallery styling */
  .gallery { 
    display:flex; 
    flex-wrap:wrap; 
    gap:1rem; 
    justify-content:center; 
  }

  .meme-card {
    display: inline-block; /* shrink-wrap to image */
    border: 5px solid #39FF14; /* neon frame */
    border-radius: 8px;
    overflow: hidden;
    text-align: center;
    margin: 10px;
  }

  .meme-card img {
    display: block;
    max-width: 100%; /* scale down on smaller screens */
    height: auto;    /* preserve aspect ratio */
  }

  .meme-card .author {
    background: #fff;  /* padded frame */
    color: #000;
    font-weight: bold;
    padding: 5px 10px;
    margin-top: 5px;
    display: inline-block;
  }

  /* Floating footer */
  #floatingFooter {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: #000;
    padding: 10px 20px;
    border: 2px solid #39FF14;
    border-radius: 20px;
    color:#39FF14;
    font-weight:bold;
    text-align:center;
    z-index:1000;
    animation: pulse 1.5s infinite alternate;
  }

  #floatingFooter a {
    color:#39FF14;
    text-decoration:none;
  }

  #floatingFooter a:hover {
    text-decoration: underline;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 10px #39FF14, 0 0 20px #39FF14, 0 0 30px #39FF14; }
    100% { box-shadow: 0 0 20px #39FF14, 0 0 40px #39FF14, 0 0 60px #39FF14; }
  }
</style>
</head>
<body>

<header>
  <h1>Symbiotic Meme Gallery</h1>
  <p>Share your memes! Upload a file or paste an image URL.</p>
</header>

<main>
  <form id="memeForm">
    <input type="text" id="handle" placeholder="@yourhandle" required>
    <input type="url" id="memeUrl" placeholder="Paste image URL (optional)">
    <input type="file" id="memeFile" accept="image/*">
    <progress id="uploadProgress" value="0" max="100"></progress>
    <button type="submit" id="submitBtn">Submit</button>
  </form>

  <div class="gallery" id="gallery"></div>
</main>

<div id="floatingFooter">
  Built by <a href="https://x.com/GbolahanPhilip" target="_blank">g9gbobzy</a>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://jzofwfixzsotrcmrxlsx.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6b2Z3Zml4enNvdHJjbXJ4bHN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTczODcsImV4cCI6MjA3Mzg5MzM4N30.zgV7-3R0cuopTtw8caZaYnkM5Mxg1bphJzkuvZGuf-8'

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
const form = document.getElementById('memeForm')
const gallery = document.getElementById('gallery')
const submitBtn = document.getElementById('submitBtn')
const progressBar = document.getElementById('uploadProgress')

// Load memes
async function loadMemes() {
  gallery.innerHTML = ''
  const { data, error } = await supabase.from('meme').select('*').order('created_at', { ascending: false })
  if(error) return console.error(error)
  data.forEach(meme => {
    const card = document.createElement('div')
    card.className = 'meme-card'
    card.innerHTML = `
      <img src="${meme.url}" alt="Meme by ${meme.handle}" onerror="this.src='https://via.placeholder.com/250x260?text=Image+Not+Found'">
      <div class="author">${meme.handle}</div>
    `
    gallery.appendChild(card)
  })
}

// Form submission
form.addEventListener('submit', async e => {
  e.preventDefault()
  const handle = document.getElementById('handle').value.trim()
  const file = document.getElementById('memeFile').files[0]
  const urlInput = document.getElementById('memeUrl').value.trim()

  if(!handle) return alert('Enter your handle')
  if(!file && !urlInput) return alert('Upload file or provide URL')

  submitBtn.disabled = true
  submitBtn.textContent = 'Uploading...'
  progressBar.style.display = 'block'
  progressBar.value = 0

  let fileUrl = urlInput || ''

  try {
    if(file) {
      const formData = new FormData()
      formData.append('file', file)
      formData.append('upload_preset','symbiotic_memes')

      const xhr = new XMLHttpRequest()
      xhr.open('POST','https://api.cloudinary.com/v1_1/dm9w3jwq8/image/upload')
      xhr.upload.addEventListener('progress', e => {
        if(e.lengthComputable) progressBar.value = (e.loaded/e.total)*100
      })

      const cloudRes = await new Promise((resolve, reject) => {
        xhr.onload = () => {
          const res = JSON.parse(xhr.responseText)
          if(xhr.status===200 && res.secure_url) resolve(res)
          else reject(new Error(res.error?.message || 'Cloudinary upload failed'))
        }
        xhr.onerror = () => reject(new Error('Upload network error'))
        xhr.send(formData)
      })
      fileUrl = cloudRes.secure_url
    }

    if(!fileUrl) throw new Error('No valid image to save')

    const { error } = await supabase.from('meme').insert([{ handle, url:fileUrl }])
    if(error) throw new Error(`Supabase insert failed: ${error.message}`)

    form.reset()
    loadMemes()
  } catch(err) {
    alert(`Upload failed: ${err.message}`)
    console.error(err)
  } finally {
    submitBtn.disabled = false
    submitBtn.textContent = 'Submit'
    progressBar.style.display = 'none'
  }
})

// Initial load
loadMemes()
</script>
</body>
</html>
