<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Symbiotic Meme Upload</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #meme-feed img { max-width: 200px; margin: 10px; border-radius: 10px; }
  </style>
</head>
<body>
  <h2>Upload Meme</h2>
  <input type="text" id="handle" placeholder="Your handle"><br><br>
  <input type="file" id="fileInput" accept="image/*"><br><br>
  <button onclick="uploadMeme()">Upload</button>

  <h2>Meme Feed</h2>
  <div id="meme-feed"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Supabase credentials
    const SUPABASE_URL = "https://jzofwfixzsotrcmrxlsx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6b2Z3Zml4enNvdHJjbXJ4bHN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTczODcsImV4cCI6MjA3Mzg5MzM4N30.zgV7-3R0cuopTtw8caZaYnkM5Mxg1bphJzkuvZGuf-8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Cloudinary details
    const CLOUD_NAME = "dm9w3jwq8";
    const UPLOAD_PRESET = "symbiotic_memes";

    // Upload Meme
    async function uploadMeme() {
      const fileInput = document.getElementById("fileInput");
      const handle = document.getElementById("handle").value.trim();
      const file = fileInput.files[0];
      if (!file || !handle) {
        alert("Please enter a handle and select a file.");
        return;
      }

      // Step 1: Upload to Cloudinary
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);

      let cloudinaryUrl;
      try {
        const res = await fetch(
          `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`,
          { method: "POST", body: formData }
        );
        const data = await res.json();
        if (data.secure_url) {
          cloudinaryUrl = data.secure_url;
        } else {
          throw new Error("Cloudinary upload failed");
        }
      } catch (err) {
        alert("Upload failed: " + err.message);
        return;
      }

      // Step 2: Save metadata to Supabase
      const { error } = await supabase.from("meme").insert([
        { handle: handle, url: cloudinaryUrl }
      ]);
      if (error) {
        alert("Supabase insert failed: " + error.message);
        return;
      }

      // Step 3: Add to UI
      displayMeme(cloudinaryUrl, handle);
      fileInput.value = "";
      document.getElementById("handle").value = "";
    }

    // Display Meme in Feed
    function displayMeme(url, handle) {
      const container = document.getElementById("meme-feed");
      const div = document.createElement("div");
      div.innerHTML = `<strong>@${handle}</strong><br><img src="${url}" alt="meme">`;
      container.prepend(div);
    }

    // Load existing memes on page load
    async function loadMemes() {
      const { data, error } = await supabase
        .from("meme")
        .select("*")
        .order("created_at", { ascending: false });
      if (error) {
        console.error("Error loading memes:", error);
        return;
      }
      data.forEach(meme => displayMeme(meme.url, meme.handle));
    }

    loadMemes();
  </script>
</body>
</html>
