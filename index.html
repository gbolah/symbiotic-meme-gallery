<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // Firebase config (Firestore only)
  const firebaseConfig = {
    apiKey: "AIzaSyC2ZMSgdR1JXIig4XqSUW_Fv_e1qguzoTg",
    authDomain: "meme-gallery-36502.firebaseapp.com",
    projectId: "meme-gallery-36502",
    storageBucket: "meme-gallery-36502.appspot.com",
    messagingSenderId: "260214027111",
    appId: "1:260214027111:web:ab08f479357ae55ffb35c2",
    measurementId: "G-XVD1331589"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const form = document.getElementById("memeForm");
  const gallery = document.getElementById("gallery");

  // Realtime listener for memes
  onSnapshot(collection(db, "memes"), (snapshot) => {
    gallery.innerHTML = "";
    snapshot.forEach((doc) => {
      const meme = doc.data();
      const memeCard = document.createElement("div");
      memeCard.className = "meme-card";
      memeCard.innerHTML = `
        <img src="${meme.url}" alt="Meme by ${meme.handle}" onerror="this.src='https://via.placeholder.com/180?text=Image+Not+Found'">
        <div class="author">meme by ${meme.handle}</div>
      `;
      gallery.prepend(memeCard);
    });
  });

  // âœ… Submit handler with once:true
  form.addEventListener("submit", handleSubmit, { once: true });

  async function handleSubmit(e) {
    e.preventDefault();

    const handle = document.getElementById("handle").value.trim();
    const file = document.getElementById("memeFile").files[0];
    const urlInput = document.getElementById("memeUrl").value.trim();

    if (!handle) return alert("Please enter your handle");

    let fileUrl = urlInput;

    if (file) {
      // Upload to Cloudinary
      const data = new FormData();
      data.append("file", file);
      data.append("upload_preset", "symbiotic_memes"); // your unsigned preset
      const res = await fetch("https://api.cloudinary.com/v1_1/dm9w3jwq8/image/upload", {
        method: "POST",
        body: data
      });
      const cloudinaryResponse = await res.json();
      fileUrl = cloudinaryResponse.secure_url;
    }

    if (!fileUrl) return alert("Please upload a file or enter an image URL");

    // Save to Firestore
    await addDoc(collection(db, "memes"), {
      handle: handle,
      url: fileUrl,
      createdAt: Date.now()
    });

    form.reset();

    // Re-attach listener so form can be used again
    form.addEventListener("submit", handleSubmit, { once: true });
  }
</script>
