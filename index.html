form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const handle = document.getElementById("handle").value.trim();
  const file = document.getElementById("memeFile").files[0];
  const urlInput = document.getElementById("memeUrl").value.trim();

  if (!handle) return alert("Please enter your handle");
  if (!file && !urlInput) return alert("Please upload a file or enter an image URL");

  submitBtn.disabled = true;
  submitBtn.textContent = "Uploading...";

  let fileUrl = urlInput;

  try {
    if (file) {
      const data = new FormData();
      data.append("file", file);
      data.append("upload_preset", "symbiotic_memes"); // your Cloudinary unsigned preset
      const res = await fetch("https://api.cloudinary.com/v1_1/dm9w3jwq8/image/upload", {
        method: "POST",
        body: data
      });

      const json = await res.json();

      if (!res.ok) {
        console.error("Cloudinary HTTP error:", res.status, res.statusText, json);
        throw new Error(`Cloudinary HTTP error ${res.status}`);
      }

      if (!json.secure_url) {
        console.error("Cloudinary response missing secure_url:", json);
        throw new Error("Cloudinary upload did not return a secure_url");
      }

      fileUrl = json.secure_url;
    }

    // Save to Supabase / Firestore
    await addDoc(collection(db, "memes"), {
      handle,
      url: fileUrl,
      createdAt: Date.now()
    });

    form.reset();
  } catch (err) {
    console.error("Upload failed:", err);
    alert(`Upload failed: ${err.message}`);
  }

  submitBtn.disabled = false;
  submitBtn.textContent = "Submit";
});
